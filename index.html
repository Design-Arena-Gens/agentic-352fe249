<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Global Crypto Portfolio Dashboard</title>
  <meta name="description" content="Live crypto portfolio with buy/sell simulation, prices in USD & INR, and high-impact global events shown in Indian time." />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            background: '#0B1220',
            card: '#111827',
            accent: '#22d3ee',
            greenish: '#10b981',
            reddish: '#ef4444'
          },
          boxShadow: {
            soft: '0 10px 30px rgba(0,0,0,0.35)'
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    html, body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji'; }
    .glass { background: rgba(17, 24, 39, 0.7); backdrop-filter: blur(10px); }
    .scroll-slim::-webkit-scrollbar { height: 6px; width: 6px; }
    .scroll-slim::-webkit-scrollbar-thumb { background: #334155; border-radius: 8px; }
    .scroll-slim::-webkit-scrollbar-track { background: transparent; }
  </style>
</head>
<body class="h-full bg-background text-slate-100">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="sticky top-0 z-40 glass shadow-soft">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-accent/20 grid place-items-center">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-accent">
                <path d="M12 2L2 7l10 5 10-5-10-5zm0 8.75L5 7l7-3.5L19 7l-7 3.75z"/>
                <path d="M2 17l10 5 10-5"/>
              </svg>
            </div>
            <h1 class="text-xl sm:text-2xl font-bold tracking-tight">Global Crypto Portfolio</h1>
            <span id="last-updated" class="text-xs text-slate-400 hidden sm:inline"></span>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-right">
              <div class="text-xs text-slate-400">India Standard Time</div>
              <div id="clock-ist" class="text-sm font-semibold">--:--:--</div>
            </div>
            <button id="refresh-btn" class="px-3 py-1.5 rounded-md bg-slate-800 hover:bg-slate-700 text-sm border border-slate-700">Refresh</button>
          </div>
        </div>
      </div>
      <div class="w-full bg-slate-900 border-t border-slate-800">
        <div class="mx-auto max-w-7xl px-2 sm:px-6 lg:px-8">
          <div class="tradingview-widget-container py-1">
            <div class="tradingview-widget-container__widget" id="ticker-tape"></div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="mx-auto w-full max-w-7xl px-4 sm:px-6 lg:px-8 py-6 space-y-6">
      <!-- Summary cards -->
      <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="glass rounded-xl p-4 border border-slate-800">
          <div class="text-slate-400 text-xs">Total Value</div>
          <div id="total-value-usd" class="text-2xl font-bold mt-1">$0.00</div>
          <div id="total-value-inr" class="text-sm text-slate-300">?0.00</div>
        </div>
        <div class="glass rounded-xl p-4 border border-slate-800">
          <div class="text-slate-400 text-xs">24h Change</div>
          <div id="total-change-usd" class="text-2xl font-bold mt-1 text-slate-200">$0.00</div>
          <div id="total-change-pct" class="text-sm">0.00%</div>
        </div>
        <div class="glass rounded-xl p-4 border border-slate-800">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-slate-400 text-xs">Unrealized PnL</div>
              <div id="total-pnl-usd" class="text-2xl font-bold mt-1">$0.00</div>
            </div>
            <div class="flex gap-2">
              <button id="export-btn" class="px-3 py-1.5 rounded-md bg-slate-800 hover:bg-slate-700 text-xs border border-slate-700">Export</button>
              <button id="import-btn" class="px-3 py-1.5 rounded-md bg-slate-800 hover:bg-slate-700 text-xs border border-slate-700">Import</button>
              <button id="reset-btn" class="px-3 py-1.5 rounded-md bg-slate-800 hover:bg-slate-700 text-xs border border-slate-700 text-red-300">Reset</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Controls -->
      <section class="glass rounded-xl p-4 border border-slate-800">
        <div class="flex flex-col md:flex-row md:items-end gap-4">
          <div class="flex-1">
            <label class="block text-xs text-slate-400 mb-1">Add Asset</label>
            <input id="asset-search" list="asset-list" placeholder="Search by name or symbol (e.g., BTC, ETH)" class="w-full px-3 py-2 rounded-md bg-slate-900 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-accent/50" />
            <datalist id="asset-list"></datalist>
          </div>
          <div>
            <label class="block text-xs text-slate-400 mb-1">Quantity</label>
            <input id="asset-qty" type="number" step="any" min="0" value="0" class="w-40 px-3 py-2 rounded-md bg-slate-900 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-accent/50" />
          </div>
          <div>
            <button id="buy-asset-btn" class="px-4 py-2 rounded-md bg-greenish/20 hover:bg-greenish/30 text-greenish border border-greenish/30">Buy at Market</button>
          </div>
        </div>
      </section>

      <!-- Portfolio Table -->
      <section class="glass rounded-xl border border-slate-800 overflow-hidden">
        <div class="px-4 py-3 border-b border-slate-800 flex items-center justify-between">
          <h2 class="font-semibold">Your Portfolio</h2>
          <div class="text-xs text-slate-400">Prices auto-refresh every 15s</div>
        </div>
        <div class="overflow-auto scroll-slim">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-900/60">
              <tr class="text-slate-400 text-xs uppercase">
                <th class="text-left px-4 py-3">Asset</th>
                <th class="text-right px-4 py-3">Price (USD)</th>
                <th class="text-right px-4 py-3">Price (INR)</th>
                <th class="text-right px-4 py-3">24h %</th>
                <th class="text-right px-4 py-3">Qty</th>
                <th class="text-right px-4 py-3">Avg Cost</th>
                <th class="text-right px-4 py-3">Value</th>
                <th class="text-right px-4 py-3">PnL</th>
                <th class="text-right px-4 py-3">Actions</th>
              </tr>
            </thead>
            <tbody id="portfolio-body" class="divide-y divide-slate-800"></tbody>
          </table>
        </div>
      </section>

      <!-- Economic Calendar (High Impact, IST) -->
      <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 glass rounded-xl p-0 border border-slate-800 overflow-hidden">
          <div class="px-4 py-3 border-b border-slate-800 flex items-center justify-between">
            <h2 class="font-semibold">Global High-Impact Events (IST)</h2>
            <span class="text-xs text-slate-400">TradingView Economic Calendar</span>
          </div>
          <div class="tradingview-widget-container">
            <div class="tradingview-widget-container__widget" id="tv-calendar"></div>
          </div>
        </div>
        <div class="glass rounded-xl p-0 border border-slate-800 overflow-hidden">
          <div class="px-4 py-3 border-b border-slate-800 flex items-center justify-between">
            <h2 class="font-semibold">Top Movers (24h)</h2>
            <button id="reload-movers" class="text-xs bg-slate-800 border border-slate-700 px-2 py-1 rounded">Reload</button>
          </div>
          <div id="movers" class="p-3 space-y-2"></div>
        </div>
      </section>
    </main>
  </div>

  <template id="row-template">
    <tr>
      <td class="px-4 py-3">
        <div class="flex items-center gap-3">
          <img class="w-6 h-6 rounded-full bg-slate-800" />
          <div>
            <div class="font-medium"></div>
            <div class="text-xs text-slate-400 symbol"></div>
          </div>
        </div>
      </td>
      <td class="px-4 py-3 text-right price-usd">$0.00</td>
      <td class="px-4 py-3 text-right price-inr">?0.00</td>
      <td class="px-4 py-3 text-right change-24h">0.00%</td>
      <td class="px-4 py-3 text-right qty">0</td>
      <td class="px-4 py-3 text-right avg-cost">$0.00</td>
      <td class="px-4 py-3 text-right value">$0.00</td>
      <td class="px-4 py-3 text-right pnl">$0.00</td>
      <td class="px-4 py-3 text-right">
        <div class="flex justify-end gap-2">
          <button class="sell px-2 py-1 rounded bg-red-500/15 text-red-300 border border-red-500/30 text-xs">Sell</button>
          <button class="buy px-2 py-1 rounded bg-green-500/15 text-green-300 border border-green-500/30 text-xs">Buy</button>
        </div>
      </td>
    </tr>
  </template>

  <script>
    // --- Constants & State ---
    const API_BASE = 'https://api.coingecko.com/api/v3';
    const POLL_MS = 15000; // 15 seconds
    const IST_TZ = 'Asia/Kolkata';

    let marketsUSD = new Map(); // id -> market row (USD)
    let priceINR = new Map();   // id -> { inr, inr_24h_change }
    let portfolio = loadPortfolio(); // id -> { id, symbol, name, quantity, avgCostUSD }
    let pollTimer = null;

    function loadPortfolio() {
      try {
        const raw = localStorage.getItem('portfolio_v1');
        if (!raw) return {};
        const p = JSON.parse(raw);
        return p && typeof p === 'object' ? p : {};
      } catch { return {}; }
    }
    function savePortfolio() {
      localStorage.setItem('portfolio_v1', JSON.stringify(portfolio));
    }

    // --- Formatting helpers ---
    function formatUSD(n) {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }).format(n || 0);
    }
    function formatINR(n) {
      return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(n || 0);
    }
    function formatPct(n) {
      const v = (n || 0);
      const cls = v >= 0 ? 'text-greenish' : 'text-reddish';
      return `<span class="${cls}">${v.toFixed(2)}%</span>`;
    }
    function nowISTString() {
      return new Intl.DateTimeFormat('en-IN', {
        timeZone: IST_TZ,
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        year: 'numeric', month: 'short', day: '2-digit'
      }).format(new Date());
    }

    // --- API ---
    async function fetchMarketsUSD() {
      // Top 150 coins by market cap
      const url = `${API_BASE}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=150&page=1&sparkline=false&price_change_percentage=24h`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error('Failed to fetch USD markets');
      const data = await res.json();
      marketsUSD.clear();
      for (const row of data) {
        marketsUSD.set(row.id, row);
      }
      return data;
    }

    async function fetchINRFor(ids) {
      if (!ids.length) return new Map();
      const chunked = [];
      for (let i = 0; i < ids.length; i += 120) chunked.push(ids.slice(i, i + 120));
      const result = new Map();
      for (const chunk of chunked) {
        const url = `${API_BASE}/simple/price?ids=${encodeURIComponent(chunk.join(','))}&vs_currencies=inr&include_24hr_change=true`;
        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error('Failed to fetch INR');
        const data = await res.json();
        for (const [id, v] of Object.entries(data)) {
          result.set(id, { inr: v.inr, inr_24h_change: v.inr_24h_change });
        }
      }
      return result;
    }

    // --- UI Render ---
    function populateAssetList() {
      const dl = document.getElementById('asset-list');
      dl.innerHTML = '';
      const rows = Array.from(marketsUSD.values());
      for (const row of rows) {
        const opt = document.createElement('option');
        opt.value = `${row.symbol.toUpperCase()} - ${row.name}`;
        opt.setAttribute('data-id', row.id);
        dl.appendChild(opt);
      }
    }

    function findAssetIdFromInput() {
      const input = document.getElementById('asset-search');
      const value = (input.value || '').toLowerCase().trim();
      if (!value) return null;
      // Try direct symbol match first
      for (const row of marketsUSD.values()) {
        if (row.symbol.toLowerCase() === value || `${row.symbol.toLowerCase()} - ${row.name.toLowerCase()}` === value) return row.id;
      }
      // Try leading token from "SYMBOL - Name"
      const sym = value.split('-')[0]?.trim();
      for (const row of marketsUSD.values()) {
        if (row.symbol.toLowerCase() === sym) return row.id;
      }
      // Try name contains
      for (const row of marketsUSD.values()) {
        if (row.name.toLowerCase() === value) return row.id;
      }
      return null;
    }

    function renderPortfolio() {
      const tbody = document.getElementById('portfolio-body');
      tbody.innerHTML = '';
      let totalValueUSD = 0;
      let totalChangeUSD = 0;
      let totalCostUSD = 0;

      const template = document.getElementById('row-template');

      const ids = Object.keys(portfolio);
      ids.sort((a, b) => {
        const aVal = (marketsUSD.get(a)?.current_price || 0) * (portfolio[a]?.quantity || 0);
        const bVal = (marketsUSD.get(b)?.current_price || 0) * (portfolio[b]?.quantity || 0);
        return bVal - aVal;
      });

      for (const id of ids) {
        const pos = portfolio[id];
        const m = marketsUSD.get(id);
        if (!m) continue;
        const inr = priceINR.get(id)?.inr ?? null;

        const currentPriceUSD = m.current_price || 0;
        const changePct = m.price_change_percentage_24h ?? 0;
        const qty = Number(pos.quantity || 0);
        const valueUSD = qty * currentPriceUSD;
        const avg = Number(pos.avgCostUSD || 0);
        const pnl = qty * (currentPriceUSD - avg);

        totalValueUSD += valueUSD;
        totalCostUSD += qty * avg;
        totalChangeUSD += valueUSD * (changePct / 100);

        const tr = template.content.firstElementChild.cloneNode(true);
        tr.dataset.id = id;

        const img = tr.querySelector('img');
        img.src = m.image;
        img.alt = m.symbol.toUpperCase();
        tr.querySelector('.font-medium').textContent = m.name;
        tr.querySelector('.symbol').textContent = m.symbol.toUpperCase();

        tr.querySelector('.price-usd').textContent = formatUSD(currentPriceUSD);
        tr.querySelector('.price-inr').textContent = inr ? formatINR(inr) : '?';
        tr.querySelector('.change-24h').innerHTML = formatPct(changePct);
        tr.querySelector('.qty').textContent = qty;
        tr.querySelector('.avg-cost').textContent = formatUSD(avg);
        tr.querySelector('.value').textContent = formatUSD(valueUSD);
        tr.querySelector('.pnl').innerHTML = `${pnl >= 0 ? '<span class="text-greenish">' : '<span class="text-reddish">'}${formatUSD(pnl)}</span>`;

        tr.querySelector('.buy').addEventListener('click', () => openTradeModal('buy', id));
        tr.querySelector('.sell').addEventListener('click', () => openTradeModal('sell', id));

        tbody.appendChild(tr);
      }

      // Summary
      document.getElementById('total-value-usd').textContent = formatUSD(totalValueUSD);
      // estimate INR using BTC inr ratio if available or first id
      let totalINR = 0;
      for (const id of ids) {
        const m = marketsUSD.get(id); const inr = priceINR.get(id)?.inr;
        const qty = Number(portfolio[id]?.quantity || 0);
        if (m && inr) totalINR += qty * inr;
      }
      document.getElementById('total-value-inr').textContent = totalINR ? formatINR(totalINR) : '?0';

      document.getElementById('total-change-usd').textContent = formatUSD(totalChangeUSD);
      const pct = totalValueUSD ? (totalChangeUSD / (totalValueUSD - totalChangeUSD)) * 100 : 0;
      document.getElementById('total-change-pct').innerHTML = formatPct(pct);

      const totalPnL = totalValueUSD - totalCostUSD;
      const pnlEl = document.getElementById('total-pnl-usd');
      pnlEl.innerHTML = totalPnL >= 0 ? `<span class="text-greenish">${formatUSD(totalPnL)}</span>` : `<span class="text-reddish">${formatUSD(totalPnL)}</span>`;
    }

    // --- Trading (Buy/Sell) ---
    function buyAtMarket(id, qty) {
      qty = Number(qty);
      if (!id || !marketsUSD.has(id) || !(qty > 0)) return;
      const price = marketsUSD.get(id).current_price || 0;
      const sym = marketsUSD.get(id).symbol.toUpperCase();
      const name = marketsUSD.get(id).name;

      if (!portfolio[id]) {
        portfolio[id] = { id, symbol: sym, name, quantity: 0, avgCostUSD: 0 };
      }
      const pos = portfolio[id];
      const oldQty = Number(pos.quantity || 0);
      const oldAvg = Number(pos.avgCostUSD || 0);
      const newQty = oldQty + qty;
      const newAvg = newQty === 0 ? 0 : ((oldQty * oldAvg) + (qty * price)) / newQty;

      pos.quantity = newQty;
      pos.avgCostUSD = newAvg;
      savePortfolio();
      renderPortfolio();
    }

    function sellAtMarket(id, qty) {
      qty = Number(qty);
      if (!id || !marketsUSD.has(id) || !(qty > 0)) return;
      if (!portfolio[id]) return;
      const pos = portfolio[id];
      const oldQty = Number(pos.quantity || 0);
      const newQty = Math.max(0, oldQty - qty);
      pos.quantity = newQty;
      if (newQty === 0) {
        // Keep avg cost at 0 when fully exited
        pos.avgCostUSD = 0;
      }
      savePortfolio();
      renderPortfolio();
    }

    function openTradeModal(side, id) {
      const m = marketsUSD.get(id);
      const action = side === 'buy' ? 'Buy' : 'Sell';
      const qty = prompt(`${action} ${m.symbol.toUpperCase()} quantity at market price (${formatUSD(m.current_price)}):`, '0');
      if (qty === null) return;
      const v = Number(qty);
      if (!(v > 0)) return;
      if (side === 'buy') buyAtMarket(id, v); else sellAtMarket(id, v);
    }

    // --- Top Movers ---
    function renderTopMovers() {
      const c = document.getElementById('movers');
      const rows = Array.from(marketsUSD.values());
      rows.sort((a, b) => Math.abs(b.price_change_percentage_24h || 0) - Math.abs(a.price_change_percentage_24h || 0));
      const top = rows.slice(0, 10);
      c.innerHTML = '';
      for (const r of top) {
        const pct = r.price_change_percentage_24h || 0;
        const up = pct >= 0;
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between px-3 py-2 rounded-md bg-slate-900 border border-slate-800';
        row.innerHTML = `
          <div class="flex items-center gap-3">
            <img src="${r.image}" class="w-5 h-5 rounded-full" alt="${r.symbol.toUpperCase()}" />
            <div class="text-sm font-medium">${r.name} <span class="text-xs text-slate-400">${r.symbol.toUpperCase()}</span></div>
          </div>
          <div class="text-right">
            <div class="text-sm">${formatUSD(r.current_price)}</div>
            <div class="text-xs ${up ? 'text-greenish' : 'text-reddish'}">${up ? '?' : '?'} ${pct.toFixed(2)}%</div>
          </div>`;
        c.appendChild(row);
      }
    }

    // --- Initialize & Polling ---
    async function refreshAll() {
      try {
        const data = await fetchMarketsUSD();
        populateAssetList();
        const ids = Array.from(new Set([
          ...Object.keys(portfolio),
          ...data.map(d => d.id)
        ]));
        priceINR = await fetchINRFor(ids);
        renderPortfolio();
        renderTopMovers();
        document.getElementById('last-updated').textContent = `Updated: ${nowISTString()}`;
      } catch (e) {
        console.error(e);
      }
    }

    function startPolling() {
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(refreshAll, POLL_MS);
    }

    function setupHeaderClock() {
      const el = document.getElementById('clock-ist');
      const tick = () => el.textContent = new Intl.DateTimeFormat('en-IN', {
        timeZone: IST_TZ, hour: '2-digit', minute: '2-digit', second: '2-digit'
      }).format(new Date());
      tick();
      setInterval(tick, 1000);
    }

    function setupControls() {
      document.getElementById('refresh-btn').addEventListener('click', refreshAll);
      document.getElementById('reload-movers').addEventListener('click', renderTopMovers);
      document.getElementById('buy-asset-btn').addEventListener('click', () => {
        const id = findAssetIdFromInput();
        const qty = Number(document.getElementById('asset-qty').value || 0);
        if (!id || !(qty > 0)) return;
        buyAtMarket(id, qty);
      });
      document.getElementById('export-btn').addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(portfolio, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `portfolio-${Date.now()}.json`;
        a.click();
      });
      document.getElementById('import-btn').addEventListener('click', async () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json';
        input.onchange = async () => {
          const file = input.files[0];
          if (!file) return;
          const text = await file.text();
          try {
            const data = JSON.parse(text);
            if (data && typeof data === 'object') {
              portfolio = data;
              savePortfolio();
              renderPortfolio();
            }
          } catch {}
        };
        input.click();
      });
      document.getElementById('reset-btn').addEventListener('click', () => {
        if (!confirm('Reset your entire portfolio?')) return;
        portfolio = {};
        savePortfolio();
        renderPortfolio();
      });
    }

    function mountTradingViewWidgets() {
      // Ticker Tape
      const tapeScript = document.createElement('script');
      tapeScript.type = 'text/javascript';
      tapeScript.async = true;
      tapeScript.src = 'https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js';
      tapeScript.innerHTML = JSON.stringify({
        symbols: [
          { proName: 'BINANCE:BTCUSDT', title: 'BTC/USDT' },
          { proName: 'BINANCE:ETHUSDT', title: 'ETH/USDT' },
          { proName: 'BINANCE:SOLUSDT', title: 'SOL/USDT' },
          { proName: 'BINANCE:BNBUSDT', title: 'BNB/USDT' },
          { proName: 'BINANCE:XRPUSDT', title: 'XRP/USDT' },
          { proName: 'BINANCE:DOGEUSDT', title: 'DOGE/USDT' }
        ],
        showSymbolLogo: true,
        colorTheme: 'dark',
        isTransparent: true,
        displayMode: 'adaptive',
        locale: 'en'
      });
      document.getElementById('ticker-tape').appendChild(tapeScript);

      // Economic Calendar - high impact only, IST
      const calScript = document.createElement('script');
      calScript.type = 'text/javascript';
      calScript.async = true;
      calScript.src = 'https://s3.tradingview.com/external-embedding/embed-widget-events.js';
      calScript.innerHTML = JSON.stringify({
        colorTheme: 'dark',
        isTransparent: true,
        width: '100%',
        height: '560',
        locale: 'en',
        importanceFilter: '3', // High impact only
        currencyFilter: 'USD,EUR,JPY,GBP,INR,CNY,CHF,AUD,CAD,NZD',
        timezone: 'Asia/Kolkata'
      });
      document.getElementById('tv-calendar').appendChild(calScript);
    }

    // Boot
    window.addEventListener('DOMContentLoaded', async () => {
      setupHeaderClock();
      setupControls();
      mountTradingViewWidgets();
      await refreshAll();
      startPolling();
    });
  </script>
</body>
</html>
